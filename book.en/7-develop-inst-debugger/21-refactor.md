## 重构代码

此前的章节中，为了更方便介绍，示例代码 [godbg](https://github.com/hitzhangjie/godbg) 中，我们并没有对该调试器的软件架构做周密的设计，基本上每一个调试功能的实现，我们都是一个cobra cmd来实现，ui、符号层、目标层没有清晰的边界、代码重复率比较高，也缺乏单测来保证代码质量。

之前的实现方式，在讲解时，是方便一些，读者看起来也比较好接受一些，因为基本上一个源文件的篇幅就是一个cmd的实现，而且目前看来一个源文件的代码量可以接受。

随着支持的命令字增多，以及后续要为符号级调试器开发做准备，我们需要设计一下对应的软件架构，并针对性的做些重构。不然，后续讲解起来、读者接受起来会比较痛苦。

大致有以下基本的要求：

- 交互层、符号层、目标层，要有清晰的边界；
  - 交互层负责与用户的交互；
  - 符号层负责源码、调试符号的解析；
  - 目标层负责对目标进程进行调试控制；
- 实现时注意添加注释、合理组织代码逻辑，注意控制圈复杂度、代码重复率等等；
- 有意识地向TDD靠拢，注意每项特性的变更有测试覆盖，避免重构改变代码行为；

说一千道一万，这里是为了向过去的野蛮式生长做个告别，接下来的任务，工作量也不小，涉及到的编码也不少，我们需要依赖一些最佳实践来保证代码质量。

截止到撰写该小节时，作者已经基本完成了 [godbg](https://github.com/hitzhangjie/godbg) 的重构工作，涉及到的提交包括：

- [76302ff](https://github.com/hitzhangjie/godbg/commit/76302ff)
- [f30b0c9](https://github.com/hitzhangjie/godbg/commit/f30b0c9)
- [3dae48c](https://github.com/hitzhangjie/godbg/commit/3dae48c)
- [a88587e](https://github.com/hitzhangjie/godbg/commit/a88587e)
- [97fa3a8](https://github.com/hitzhangjie/godbg/commit/97fa3a8)

您可以运行 `git diff 97fa3a8 76302ff` 来查看详细的内容变更情况。

这里的改动除了部分重构，也有少量新特性添加，少量bugfix，涉及内容主要包括：

- 将添加断点、移除断点、step、continue、读写内存寄存器类基础操作，移到
  目标层package target/*来完成，ui层、符号层通过目标层对被调试进程进行控制；

- 为被调试进程启动一个专门的goroutine对ptrace请求进行处理，以保证ptrace
  请求来自相同tracer（线程），否则内核可能无法正常处理请求；
- 调试多线程程序时，允许枚举线程列表并跟踪，并支持对新创建线程自动跟踪；

- 修复了某些需要rewind pc、恢复添加断点前数据、事后再加回断点的场景；

- 区分被调试进程类型，debug启动、exec启动或者attach运行中进程，以便在调
  试会话退出时清理，如debug启动方式需要杀死进程并清理构建的二进制文件，exec启动方式则需要杀死进程，attach方式需要恢复进程执行；

- 其他小优化；

这里的重构、新特性支持、bugfix，为后续进一步开发符号级调试器清理了一些障碍，我们后续应该会走的更稳健轻松一些。